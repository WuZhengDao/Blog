---


title: 分布式架构笔记
date: 2020-01-29 00:01:40
tags:
categories:
---

# 分布式系统框架设计

## 什么是分布式消息中间件

### 单体架构->分布式架构

![1580227715558](E:\Blog\source\_drafts\1580227715558.png)

单体架构：所有代码在一台机器上，当一个功能需要升级则所有模块都需要进行升级

分布式架构：按照功能模块划分，将不同模块划分成不同系统，并部署在相互独立的机器上。当一个请求需要后台多系统协同处理。

![1580227841640](E:\Blog\source\_drafts\1580227841640.png)

ps：相互调用之间可以使用消息中间件来实现系统解耦。

ps：不同系统之间相互调用则会涉及RPC调用设计。

> 消息中间件：
>
> - 利用高效可靠的消息传递机制进行平台无关的数据交流；
>
> - 并基于数据通信来进行分布式系统的集成；
> - 通过提供消息传递和消息排队模型（生产者，消费者），它可以在分布式环境下扩展进程间的通信。
>
> 应用场景：
>
> - 跨系统数据传递、高并发流量削峰、数据异步处理等
>
> 常用消息中间件
>
> 本质：
>
> 一种具备接收请求、保存数据、发送数据等功能的网络应用。
>
> 主要扶着数据的接收和传递，性能一般高于普通程序。
>
> 核心组成：
>
> - 协议
> - 持久化机制
> - 消息分发机制
> - 高可用设计
> - 高可靠设计

## 协议

> 协议是计算机之间通信时共同遵守的一组约定，都遵守相同的约定，方便相互交流。
>
> 是对数据格式和计算机之间交换数据时必须遵守的规则的正式描述。
>
> 三要素：
>
> - 语法：数据与控制信息的结构或格式
> - 语义：发出控制信息完成何种动作及做出何种相应。
> - 时序：事件实现顺序的详细说明。
>
> 常见协议：
>
> - Http协议三要素：
>   - 语法：http规定请求报文和响应报文的具体格式。
>   - 语义：
>   - 时序：一个请求对应一个响应。
>
> 常见消息中间件协议：
>
> OpenWire (ActiveMQ) 、AMQP、MQTT、Kafka、OpenMessage
>
> Q：为什么消息中间件不直接使用Http协议？
>
> ans：
>
> ​	1、Http协议太大，功能太多，但是消息中间件追求简洁高效
>
> ​	2、Http是短链接，消息中间件一般都是请求长连接。

AMQP

- 高级消息队列协议
- 04年，摩根大通集团联合其他公司共同设计
- 特性：
  - 事务支持
  - 持久化支持
  - 出生金融行业，在可靠性消息处理上具备天然优势。
- 场景：适用于金融场景
- 应用：

MQTT协议

- 消息队列遥测传输
- IBM
- 即使通信协议
- 物联网系统架构的重要组成部分
- 特性（适用于物联网场景）：
  - 轻量
  - 结构简单
  - 传输快
  - 没有事务支持
  - 没有持久化设计
- 场景：计算能力有限、低带宽、网络不稳定场景
- 应用：

OpenMessage协议

- 由阿里发起，与雅虎、滴滴出行、Streamlio等公司共同参与窗机的分布式消息中间件、流处理领域的应用开发标准。是国内首个在全球范围内发起的分布式消息领域国际标准。
- 特性：
  - 结构简单
  - 解析快
  - 有事务设计
  - 有持久化设计
- 场景：
- 应用：Apache RocketMQ

Kafka：

- 基于TCP的二进制协议。消息内部通过长度来分隔，由一些基本数据类型组成。
- 特性：
  - 结构简单
  - 解析快
  - 无事务设计
  - 有持久化设计
- 场景：
- 应用：kafka(最初设计为日志处理)

## 持久化

> 数据是否保存，简单的讲就是将数据存入磁盘，而不是在存在内存中随服务重启而消失，是数据永久保存，叫持久化。

常见持久方式：

|          | AMQ  | RabbitMQ | kafka | RocketMQ |
| :------: | :--: | :------: | :---: | :------: |
| 文件系统 | 支持 |   支持   | 支持  |   支持   |
|  数据库  | 支持 |    /     |   /   |    /     |

所有MQ**都支持**将自己的消息保存在消息中间件之间的文件系统。

## 消息分发

消息分发方式:

- 服务端主动推送

- 消费者拉取数据

常见消息中间件分发策略：

![1580230648201](E:\Blog\source\_drafts\1580230648201.png)

## 高可靠

> 高可用性是指产品在规定的条件和规定的时刻或时间区间内处于可执行规定功能状态的能力。
>
> 当业务量大是，一台消息中间件服务器可能无法满足需求，所以需要消息中间件能够集群部署，来达到高可用的目的。

常用设计



![1580230918211](E:\Blog\source\_drafts\1580230918211.png)

![1580231011536](E:\Blog\source\_drafts\1580231011536.png)

![1580231135088](E:\Blog\source\_drafts\1580231135088.png)

![1580231177675](E:\Blog\source\_drafts\1580231177675.png)

![1580231230871](E:\Blog\source\_drafts\1580231230871.png)

## 高可用

> 高可靠性：系统可以无故障地持续运行

保证消息中间件的高可靠性可以从下面及方面考虑

- 消息传输可靠：通过协议保证系统件数据解析的正确性。
- 消息存储可靠：通过持久化来保证消息的存储可靠性。